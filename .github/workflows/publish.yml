name: Publish to Maven Central

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Determine next version
        id: version
        run: |
          # Get latest tag
          LATEST_TAG=$(git tag --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi

          # Parse version components
          VERSION="${LATEST_TAG#v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          PATCH=$(echo "$VERSION" | cut -d. -f3)

          # Determine bump type
          BUMP="${{ github.event.inputs.bump || 'auto' }}"
          if [ "$BUMP" = "auto" ]; then
            # Check commit messages since last tag
            if [ "$LATEST_TAG" = "v0.0.0" ]; then
              COMMITS=$(git log --oneline --format="%s")
            else
              COMMITS=$(git log "${LATEST_TAG}..HEAD" --oneline --format="%s")
            fi

            if echo "$COMMITS" | grep -qiE "^BREAKING CHANGE|^.*!:"; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qiE "^feat"; then
              BUMP="minor"
            else
              BUMP="patch"
            fi
          fi

          # Bump version
          case "$BUMP" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "Next version: $NEXT_VERSION ($BUMP bump from $LATEST_TAG)"

      - name: Update version in gradle.properties
        run: |
          sed -i "s/^sdkVersion=.*/sdkVersion=${{ steps.version.outputs.version }}/" gradle.properties
          cat gradle.properties

      - name: Build
        run: ./gradlew build

      - name: Publish to staging directory
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: ./gradlew publishMavenJavaPublicationToStagingRepository

      - name: Create bundle for Central Portal
        run: |
          cd build/staging-deploy
          zip -r ../bundle.zip .
          echo "Bundle contents:"
          unzip -l ../bundle.zip

      - name: Upload to Maven Central
        env:
          CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
        run: |
          TOKEN=$(echo -n "${CENTRAL_USERNAME}:${CENTRAL_PASSWORD}" | base64)
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "https://central.sonatype.com/api/v1/publisher/upload" \
            -H "Authorization: UserToken ${TOKEN}" \
            -F "bundle=@build/bundle.zip" \
            -F "name=org.ciyex:ciyex-platform-sdk:${{ steps.version.outputs.version }}" \
            -F "publishingType=AUTOMATIC")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          echo "Response: $BODY (HTTP $HTTP_CODE)"

          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Failed to publish to Maven Central: $BODY"
            exit 1
          fi

          echo "Published ${{ steps.version.outputs.version }} to Maven Central"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add gradle.properties
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }} [skip ci]"
          git push

      - name: Create tag and release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag "${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "v${{ steps.version.outputs.version }}" \
            --generate-notes
